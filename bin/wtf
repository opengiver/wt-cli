#!/bin/bash
# wtf - Worktree Flutter Switcher
# Interactive Flutter debugging with easy worktree switching
#
# Usage: wtf [device-id]
#
# Features:
#   - Arrow key navigation (‚Üë/‚Üì) + Enter to select
#   - Number keys (1-9) to jump directly
#   - tmux split mode: Navigate worktree list while Flutter runs
#   - Fallback mode: Classic menu-based selection
#
# Controls:
#   ‚Üë/‚Üì: Navigate worktree list
#   Enter: Select and run/switch
#   1-9: Jump directly to worktree
#   q: Quit

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# tmux session name
TMUX_SESSION="wtf-$$"

# Find project root (main repo, not worktree)
find_project_root() {
  local git_root=$(git rev-parse --show-toplevel 2>/dev/null)
  if [[ -z "$git_root" ]]; then
    echo ""
    return
  fi
  
  if [[ -f "$git_root/.git" ]]; then
    local gitdir=$(cat "$git_root/.git" | sed 's/gitdir: //')
    echo "$gitdir" | sed 's/\/\.git\/worktrees\/.*//'
  else
    echo "$git_root"
  fi
}

PROJECT_ROOT=$(find_project_root)
if [[ -z "$PROJECT_ROOT" ]]; then
  echo -e "${RED}Error: Not in a git repository${NC}"
  exit 1
fi

PROJECT_NAME=$(basename "$PROJECT_ROOT")
WORKTREES_DIR="$(dirname "$PROJECT_ROOT")/${PROJECT_NAME}-worktrees"
DEVICE="${1:-}"

declare -a WT_NAMES
declare -a WT_PATHS

# Find Flutter app directory
find_flutter_dir() {
  local dir="${1:-$PWD}"
  local check_dirs=("$dir" "$dir/app" "$dir/src" "$dir/client" "$dir/frontend" "$dir/mobile")
  
  for check_dir in "${check_dirs[@]}"; do
    if [[ -f "$check_dir/pubspec.yaml" ]]; then
      echo "$check_dir"
      return
    fi
  done
  
  echo ""
}

load_worktrees() {
  WT_NAMES=()
  WT_PATHS=()
  
  local main_flutter_dir=$(find_flutter_dir "$PROJECT_ROOT")
  if [[ -n "$main_flutter_dir" ]]; then
    WT_NAMES+=("main")
    WT_PATHS+=("$main_flutter_dir")
  fi
  
  if [[ -d "$WORKTREES_DIR" ]]; then
    for wt in "$WORKTREES_DIR"/*/; do
      if [[ -d "$wt" ]]; then
        local wt_flutter_dir=$(find_flutter_dir "${wt%/}")
        if [[ -n "$wt_flutter_dir" ]]; then
          local name=$(basename "$wt")
          WT_NAMES+=("$name")
          WT_PATHS+=("$wt_flutter_dir")
        fi
      fi
    done
  fi
}

# Print compact header for tmux top pane
print_compact_header() {
  local current="$1"
  echo -e "${MAGENTA}‚îÅ‚îÅ${NC} ${BOLD}ü¶ã wtf${NC} ${DIM}($PROJECT_NAME)${NC} ${MAGENTA}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  if [[ -n "$current" ]]; then
    echo -e "${GREEN}‚ñ∂${NC} ${BOLD}$current${NC} ${DIM}${DEVICE:+| üì± $DEVICE}${NC}"
  else
    echo -e "${DIM}No active worktree${NC}"
  fi
  echo ""
}

# Print full banner
print_banner() {
  local current="$1"
  echo ""
  echo -e "${MAGENTA}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
  echo -e "${MAGENTA}‚ïë${NC}  ${BOLD}ü¶ã Flutter Worktree Switcher${NC}  ${DIM}($PROJECT_NAME)${NC}          ${MAGENTA}‚ïë${NC}"
  echo -e "${MAGENTA}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
  if [[ -n "$current" ]]; then
    printf "${MAGENTA}‚ïë${NC}  ${GREEN}‚ñ∂ Active:${NC} ${BOLD}%-43s${NC}${MAGENTA}‚ïë${NC}\n" "$current"
    if [[ -n "$DEVICE" ]]; then
      printf "${MAGENTA}‚ïë${NC}  ${BLUE}üì± Device:${NC} %-43s${MAGENTA}‚ïë${NC}\n" "$DEVICE"
    fi
  fi
  echo -e "${MAGENTA}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
  echo ""
}

# Print menu with arrow key navigation
print_menu() {
  local current="$1"
  local selected_idx="${2:-0}"
  local compact="${3:-false}"
  
  if [[ "$compact" != "true" ]]; then
    echo -e "${BOLD}  Select worktree to debug:${NC}"
    echo ""
  fi
  
  for i in "${!WT_NAMES[@]}"; do
    local name="${WT_NAMES[$i]}"
    local path="${WT_PATHS[$i]}"
    local branch=$(cd "$path" && git branch --show-current 2>/dev/null || echo "unknown")
    local num=$((i + 1))
    
    if [[ $i -eq $selected_idx ]]; then
      if [[ "$name" == "$current" ]]; then
        echo -e "  ${GREEN}${BOLD}‚ñ∂ [$num] $name${NC} ${DIM}‚Üê running${NC}"
      else
        echo -e "  ${CYAN}${BOLD}‚ñ∂ [$num] $name${NC}"
      fi
      if [[ "$compact" != "true" ]]; then
        echo -e "       ${CYAN}$branch${NC}"
      fi
    else
      if [[ "$name" == "$current" ]]; then
        echo -e "    ${GREEN}[$num] $name${NC} ${DIM}‚Üê running${NC}"
        if [[ "$compact" != "true" ]]; then
          echo -e "       ${CYAN}$branch${NC}"
        fi
      else
        echo -e "    ${DIM}[$num]${NC} $name"
        if [[ "$compact" != "true" ]]; then
          echo -e "       ${DIM}$branch${NC}"
        fi
      fi
    fi
  done
  
  echo ""
  echo -e "  ${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
  echo -e "  ${BOLD}[‚Üë‚Üì]${NC} Navigate   ${BOLD}[Enter]${NC} Run   ${BOLD}[1-${#WT_NAMES[@]}]${NC} Jump   ${BOLD}[q]${NC} Quit"
  echo ""
}

# Read single keypress with arrow key support
# Returns "TIMEOUT" if no key pressed within timeout
read_key() {
  local key
  # Use 1 second timeout for periodic refresh
  if ! IFS= read -rsn1 -t 1 key 2>/dev/null; then
    echo "TIMEOUT"
    return
  fi
  
  if [[ "$key" == $'\033' ]]; then
    # Read escape sequence
    read -rsn2 -t 1 key 2>/dev/null || true
    case "$key" in
      '[A') echo "UP" ;;
      '[B') echo "DOWN" ;;
      *) echo "ESC" ;;
    esac
  elif [[ "$key" == "" ]]; then
    echo "ENTER"
  elif [[ "$key" == $'\t' ]]; then
    echo "TAB"
  elif [[ "$key" == "q" || "$key" == "Q" ]]; then
    echo "QUIT"
  elif [[ "$key" =~ ^[1-9]$ ]]; then
    echo "NUM_$key"
  else
    echo "OTHER"
  fi
}

# Run flutter for selected worktree (classic mode)
run_flutter_classic() {
  local wt_name="$1"
  local wt_path="$2"
  
  clear
  print_banner "$wt_name"
  
  local branch=$(cd "$wt_path" && git branch --show-current 2>/dev/null || echo "unknown")
  echo -e "${YELLOW}üìÇ Path:${NC} $wt_path"
  echo -e "${YELLOW}üåø Branch:${NC} $branch"
  echo ""
  echo -e "${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
  echo -e "${GREEN}üöÄ Starting Flutter...${NC}"
  echo -e "${DIM}   Press 'q' in Flutter to return to worktree selection${NC}"
  echo -e "${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
  echo ""
  
  cd "$wt_path"
  
  local flutter_cmd="flutter run"
  if [[ -n "$DEVICE" ]]; then
    flutter_cmd="$flutter_cmd -d \"$DEVICE\""
  fi
  
  eval $flutter_cmd
  
  echo ""
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${GREEN}üîÑ Flutter exited. Returning to worktree selection...${NC}"
  echo -e "${DIM}   (Press any key to continue)${NC}"
  echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  read -rsn1
  return 0
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TMUX MODE - Split view with always-visible worktree list
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

cleanup_tmux() {
  tmux kill-session -t "$TMUX_SESSION" 2>/dev/null || true
}

# Top pane: Worktree selector (runs interactively)
run_tmux_selector() {
  local session_name="$1"
  local device="$2"
  local selected_idx=0
  local current_wt=""
  
  # Use alternate screen buffer (prevents scrollback accumulation)
  printf '\033[?1049h'
  
  # Cleanup on exit - restore screen and show cursor
  trap 'printf "\033[?1049l\033[?25h"' EXIT
  
  # Hide cursor for cleaner UI
  printf '\033[?25l'
  
  while true; do
    load_worktrees
    
    if [[ ${#WT_NAMES[@]} -eq 0 ]]; then
      echo -e "${RED}‚ùå No Flutter worktrees found${NC}"
      sleep 2
      continue
    fi
    
    # Clamp selected_idx
    if [[ $selected_idx -ge ${#WT_NAMES[@]} ]]; then
      selected_idx=$((${#WT_NAMES[@]} - 1))
    fi
    
    # Clear screen (alternate buffer has no scrollback)
    printf '\033[H\033[J'
    # Compact header for tmux mode
    echo -e "${MAGENTA}‚îÅ‚îÅ${NC} ${BOLD}ü¶ã wtf${NC} ${DIM}($PROJECT_NAME)${NC} ${MAGENTA}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    if [[ -n "$current_wt" ]]; then
      echo -e "${GREEN}‚ñ∂${NC} ${BOLD}$current_wt${NC} ${DIM}${device:+| üì± $device}${NC}"
    else
      echo -e "${DIM}No active worktree${NC}"
    fi
    echo ""
    
    # Print worktree list
    for i in "${!WT_NAMES[@]}"; do
      local name="${WT_NAMES[$i]}"
      local num=$((i + 1))
      
      if [[ $i -eq $selected_idx ]]; then
        if [[ "$name" == "$current_wt" ]]; then
          echo -e "  ${GREEN}${BOLD}‚ñ∂ [$num] $name${NC} ${DIM}‚Üê running${NC}"
        else
          echo -e "  ${CYAN}${BOLD}‚ñ∂ [$num] $name${NC}"
        fi
      else
        if [[ "$name" == "$current_wt" ]]; then
          echo -e "    ${GREEN}[$num] $name${NC} ${DIM}‚Üê running${NC}"
        else
          echo -e "    ${DIM}[$num]${NC} $name"
        fi
      fi
    done
    
    echo ""
    echo -e "${DIM}[‚Üë‚Üì] Move  [Enter] Switch  [Tab] Flutter pane  [q] Quit${NC}"
    
    # Read key
    local key_action=$(read_key)
    
    case "$key_action" in
      UP)
        if [[ $selected_idx -gt 0 ]]; then
          ((selected_idx--))
        else
          selected_idx=$((${#WT_NAMES[@]} - 1))
        fi
        ;;
      DOWN)
        if [[ $selected_idx -lt $((${#WT_NAMES[@]} - 1)) ]]; then
          ((selected_idx++))
        else
          selected_idx=0
        fi
        ;;
      ENTER)
        if [[ ${#WT_NAMES[@]} -gt 0 ]]; then
          local wt_name="${WT_NAMES[$selected_idx]}"
          local wt_path="${WT_PATHS[$selected_idx]}"
          current_wt="$wt_name"
          
          # Update tmux status bar with worktree name
          tmux set-option -t "$session_name" status-right " üìÇ $wt_name " 2>/dev/null || true
          
          # Send command to bottom pane
          tmux send-keys -t "${session_name}:0.1" C-c 2>/dev/null || true
          sleep 0.3
          if [[ -n "$device" ]]; then
            tmux send-keys -t "${session_name}:0.1" "cd \"$wt_path\" && flutter run -d \"$device\"" Enter 2>/dev/null || true
          else
            tmux send-keys -t "${session_name}:0.1" "cd \"$wt_path\" && flutter run" Enter 2>/dev/null || true
          fi
        fi
        ;;
      NUM_*)
        local num=${key_action#NUM_}
        local idx=$((num - 1))
        if [[ $idx -lt ${#WT_NAMES[@]} ]]; then
          selected_idx=$idx
          local wt_name="${WT_NAMES[$idx]}"
          local wt_path="${WT_PATHS[$idx]}"
          current_wt="$wt_name"
          
          # Update tmux status bar with worktree name
          tmux set-option -t "$session_name" status-right " üìÇ $wt_name " 2>/dev/null || true
          
          # Send command to bottom pane
          tmux send-keys -t "${session_name}:0.1" C-c 2>/dev/null || true
          sleep 0.3
          if [[ -n "$device" ]]; then
            tmux send-keys -t "${session_name}:0.1" "cd \"$wt_path\" && flutter run -d \"$device\"" Enter 2>/dev/null || true
          else
            tmux send-keys -t "${session_name}:0.1" "cd \"$wt_path\" && flutter run" Enter 2>/dev/null || true
          fi
        fi
        ;;
      TAB)
        # Switch focus to Flutter pane
        tmux select-pane -t "${session_name}:0.1" 2>/dev/null || true
        ;;
      QUIT)
        tmux kill-session -t "$session_name" 2>/dev/null || true
        exit 0
        ;;
    esac
  done
}

start_tmux_mode() {
  trap cleanup_tmux EXIT
  
  local script_path=$(realpath "$0")
  
  # Create tmux session
  # Top pane (30%): Selector
  # Bottom pane (70%): Flutter output
  if [[ -n "$DEVICE" ]]; then
    tmux new-session -d -s "$TMUX_SESSION" -x "$(tput cols)" -y "$(tput lines)" \
      "\"$script_path\" --tmux-selector \"$TMUX_SESSION\" \"$DEVICE\""
  else
    tmux new-session -d -s "$TMUX_SESSION" -x "$(tput cols)" -y "$(tput lines)" \
      "\"$script_path\" --tmux-selector \"$TMUX_SESSION\" \"\""
  fi
  
  # Configure status bar style
  tmux set-option -t "$TMUX_SESSION" status-style "bg=green,fg=black,bold"
  tmux set-option -t "$TMUX_SESSION" status-left " ü¶ã wtf | "
  tmux set-option -t "$TMUX_SESSION" status-left-length 20
  tmux set-option -t "$TMUX_SESSION" status-right " üìÇ (none) "
  tmux set-option -t "$TMUX_SESSION" status-right-length 50
  
  # Enable mouse support for pane selection
  tmux set-option -t "$TMUX_SESSION" mouse on
  
  # Bind Tab key to switch between panes (works in both panes)
  tmux bind-key -n Tab select-pane -t :.+
  
  # Set pane border with titles for better visibility
  tmux set-option -t "$TMUX_SESSION" pane-border-style "fg=colour240"
  tmux set-option -t "$TMUX_SESSION" pane-active-border-style "fg=colour46"
  tmux set-option -t "$TMUX_SESSION" pane-border-status top
  tmux set-option -t "$TMUX_SESSION" pane-border-format " #{?pane_active,#[fg=colour46]‚ñ∂ ,  }#[fg=white,bold]#{pane_title}#[default] "
  
  # Split and create bottom pane for Flutter
  tmux split-window -v -t "$TMUX_SESSION" -p 70 "bash"
  
  # Set pane titles
  tmux select-pane -t "${TMUX_SESSION}:0.0" -T "üìã Worktree"
  tmux select-pane -t "${TMUX_SESSION}:0.1" -T "üöÄ Flutter"
  
  # Focus on top pane
  tmux select-pane -t "${TMUX_SESSION}:0.0"
  
  # Attach
  tmux attach-session -t "$TMUX_SESSION"
}

# Inline selector for split mode (runs in existing tmux)
run_tmux_selector_inline() {
  local device="$1"
  local selected_idx=0
  local current_wt=""
  
  # Use alternate screen buffer
  printf '\033[?1049h'
  trap 'printf "\033[?1049l\033[?25h"' EXIT
  printf '\033[?25l'
  
  while true; do
    load_worktrees
    
    if [[ ${#WT_NAMES[@]} -eq 0 ]]; then
      echo -e "${RED}‚ùå No Flutter worktrees found${NC}"
      sleep 2
      continue
    fi
    
    if [[ $selected_idx -ge ${#WT_NAMES[@]} ]]; then
      selected_idx=$((${#WT_NAMES[@]} - 1))
    fi
    
    printf '\033[H\033[J'
    
    # Header
    echo -e "${MAGENTA}‚îÅ‚îÅ${NC} ${BOLD}ü¶ã wtf${NC} ${DIM}($PROJECT_NAME)${NC} ${MAGENTA}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    if [[ -n "$current_wt" ]]; then
      echo -e "${GREEN}‚ñ∂${NC} ${BOLD}$current_wt${NC} ${DIM}${device:+| üì± $device}${NC}"
    else
      echo -e "${DIM}No active worktree${NC}"
    fi
    echo ""
    
    for i in "${!WT_NAMES[@]}"; do
      local name="${WT_NAMES[$i]}"
      local num=$((i + 1))
      
      if [[ $i -eq $selected_idx ]]; then
        if [[ "$name" == "$current_wt" ]]; then
          echo -e "  ${GREEN}${BOLD}‚ñ∂ [$num] $name${NC} ${DIM}‚Üê running${NC}"
        else
          echo -e "  ${CYAN}${BOLD}‚ñ∂ [$num] $name${NC}"
        fi
      else
        if [[ "$name" == "$current_wt" ]]; then
          echo -e "    ${GREEN}[$num] $name${NC} ${DIM}‚Üê running${NC}"
        else
          echo -e "    ${DIM}[$num]${NC} $name"
        fi
      fi
    done
    
    echo ""
    echo -e "${DIM}[‚Üë‚Üì] Move  [Enter] Switch  [Tab] Flutter pane  [q] Quit${NC}"
    
    local key_action=$(read_key)
    
    case "$key_action" in
      UP)
        if [[ $selected_idx -gt 0 ]]; then
          ((selected_idx--))
        else
          selected_idx=$((${#WT_NAMES[@]} - 1))
        fi
        ;;
      DOWN)
        if [[ $selected_idx -lt $((${#WT_NAMES[@]} - 1)) ]]; then
          ((selected_idx++))
        else
          selected_idx=0
        fi
        ;;
      ENTER)
        if [[ ${#WT_NAMES[@]} -gt 0 ]]; then
          local wt_name="${WT_NAMES[$selected_idx]}"
          local wt_path="${WT_PATHS[$selected_idx]}"
          current_wt="$wt_name"
          
          # Send to next pane (below)
          tmux send-keys -t :.+ C-c 2>/dev/null || true
          sleep 0.3
          if [[ -n "$device" ]]; then
            tmux send-keys -t :.+ "cd \"$wt_path\" && flutter run -d \"$device\"" Enter 2>/dev/null || true
          else
            tmux send-keys -t :.+ "cd \"$wt_path\" && flutter run" Enter 2>/dev/null || true
          fi
        fi
        ;;
      NUM_*)
        local num=${key_action#NUM_}
        local idx=$((num - 1))
        if [[ $idx -lt ${#WT_NAMES[@]} ]]; then
          selected_idx=$idx
          local wt_name="${WT_NAMES[$idx]}"
          local wt_path="${WT_PATHS[$idx]}"
          current_wt="$wt_name"
          
          tmux send-keys -t :.+ C-c 2>/dev/null || true
          sleep 0.3
          if [[ -n "$device" ]]; then
            tmux send-keys -t :.+ "cd \"$wt_path\" && flutter run -d \"$device\"" Enter 2>/dev/null || true
          else
            tmux send-keys -t :.+ "cd \"$wt_path\" && flutter run" Enter 2>/dev/null || true
          fi
        fi
        ;;
      QUIT)
        # Kill selector pane, keep flutter pane
        exit 0
        ;;
    esac
  done
}

# Split current tmux window (when already inside tmux)
start_tmux_split_mode() {
  local script_path=$(realpath "$0")
  local current_pane=$(tmux display-message -p '#{pane_id}')
  local current_window=$(tmux display-message -p '#{window_id}')
  
  # Store current pane to restore later
  local original_pane="$current_pane"
  
  # Create top pane with selector (30%)
  tmux split-window -v -b -p 30 -t "$current_pane" \
    "\"$script_path\" --tmux-selector-inline \"$DEVICE\""
  
  local selector_pane=$(tmux display-message -p '#{pane_id}')
  
  # Set pane titles
  tmux select-pane -t "$selector_pane" -T "üìã Worktree"
  tmux select-pane -t "$original_pane" -T "üöÄ Flutter"
  
  # Configure pane borders for current window
  tmux set-option pane-border-style "fg=colour240"
  tmux set-option pane-active-border-style "fg=colour46"
  tmux set-option pane-border-status top
  tmux set-option pane-border-format " #{?pane_active,#[fg=colour46]‚ñ∂ ,  }#[fg=white,bold]#{pane_title}#[default] "
  
  # Bind Tab to switch panes (for current window only)
  tmux bind-key -n Tab select-pane -t :.+
  
  # Focus on selector pane
  tmux select-pane -t "$selector_pane"
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# CLASSIC MODE (non-tmux fallback)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

run_classic_mode() {
  local current_idx=0
  local selected_idx=0
  local initial_pwd="$PWD"
  
  while true; do
    load_worktrees
    
    if [[ ${#WT_NAMES[@]} -eq 0 ]]; then
      echo -e "${RED}‚ùå No Flutter worktrees found${NC}"
      echo -e "${DIM}   Make sure pubspec.yaml exists in your worktrees${NC}"
      exit 1
    fi
    
    if [[ $current_idx -ge ${#WT_NAMES[@]} ]]; then
      current_idx=0
    fi
    if [[ $selected_idx -ge ${#WT_NAMES[@]} ]]; then
      selected_idx=0
    fi
    
    if [[ -n "$initial_pwd" ]]; then
      for i in "${!WT_PATHS[@]}"; do
        if [[ "$initial_pwd" == "${WT_PATHS[$i]}"* ]]; then
          current_idx=$i
          selected_idx=$i
          break
        fi
      done
      initial_pwd=""
    fi
    
    clear
    print_banner "${WT_NAMES[$current_idx]}"
    print_menu "${WT_NAMES[$current_idx]}" "$selected_idx"
    
    local key_action=$(read_key)
    
    case "$key_action" in
      UP)
        if [[ $selected_idx -gt 0 ]]; then
          ((selected_idx--))
        else
          selected_idx=$((${#WT_NAMES[@]} - 1))
        fi
        ;;
      DOWN)
        if [[ $selected_idx -lt $((${#WT_NAMES[@]} - 1)) ]]; then
          ((selected_idx++))
        else
          selected_idx=0
        fi
        ;;
      ENTER)
        current_idx=$selected_idx
        run_flutter_classic "${WT_NAMES[$selected_idx]}" "${WT_PATHS[$selected_idx]}"
        ;;
      NUM_*)
        local num=${key_action#NUM_}
        local idx=$((num - 1))
        if [[ $idx -lt ${#WT_NAMES[@]} ]]; then
          selected_idx=$idx
          current_idx=$idx
          run_flutter_classic "${WT_NAMES[$idx]}" "${WT_PATHS[$idx]}"
        fi
        ;;
      QUIT)
        echo -e "\n${YELLOW}üëã Goodbye!${NC}"
        exit 0
        ;;
    esac
  done
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# MAIN
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

main() {
  # Handle internal modes
  case "${1:-}" in
    --tmux-selector)
      shift
      run_tmux_selector "$@"
      exit 0
      ;;
    --tmux-selector-inline)
      shift
      run_tmux_selector_inline "$@"
      exit 0
      ;;
  esac
  
  # Auto-detect device
  if [[ -z "$DEVICE" ]]; then
    echo -e "${YELLOW}üîç Detecting devices...${NC}"
    DEVICE=$(flutter devices 2>/dev/null | grep -E "‚Ä¢|‚Ä¢" | head -1 | awk -F'‚Ä¢' '{print $2}' | xargs)
    if [[ -z "$DEVICE" ]]; then
      echo -e "${YELLOW}‚ö†Ô∏è  No device specified, Flutter will auto-select${NC}"
    else
      echo -e "${GREEN}üì± Using device: $DEVICE${NC}"
    fi
  fi
  
  # Check for tmux
  if command -v tmux &>/dev/null; then
    if [[ -n "$TMUX" ]]; then
      echo -e "${GREEN}‚úì Already in tmux - splitting current window${NC}"
      echo -e "${DIM}  Top: Worktree selection | Bottom: Flutter${NC}"
      sleep 1
      start_tmux_split_mode
    else
      echo -e "${GREEN}‚úì tmux detected - using split view mode${NC}"
      echo -e "${DIM}  Top: Worktree selection | Bottom: Flutter${NC}"
      sleep 1
      start_tmux_mode
    fi
  else
    echo -e "${YELLOW}‚ö†Ô∏è  tmux not found - using classic mode${NC}"
    echo -e "${DIM}  Install tmux for split view: brew install tmux${NC}"
    sleep 1
    run_classic_mode
  fi
}

main "$@"
